<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - 404-Service</title>
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/stats.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.2.3/css/flag-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="glow"></div>
    <div class="glow glow-right"></div>
    <main class="dashboard-main">
        <header>
            <h1>Service Statistics</h1>
            <p class="header-sub">Real-time analytics for 404 API fetches</p>
            <p class="header-sub">We store absolutely nothing. No IPs, no personal data — only anonymous aggregate stats</p>
        </header>

        <div class="kpi-row">
            <div class="card kpi-card">
                <div class="kpi-label">Total API Fetches</div>
                <div id="fetchCount" class="kpi-value">...</div>
                <div id="fetchTrend" class="kpi-sub"></div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Top Browser</div>
                <div class="kpi-value-row">
                    <span id="topBrowserIcon" class="kpi-icon"></span>
                    <div id="topBrowser" class="kpi-value">—</div>
                </div>
                <div id="topBrowserPct" class="kpi-sub"></div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Top Country</div>
                <div class="kpi-value-row">
                    <span id="topCountryFlag" class="kpi-icon"></span>
                    <div id="topCountry" class="kpi-value">—</div>
                </div>
                <div id="topCountryPct" class="kpi-sub"></div>
            </div>
        </div>

        <div class="card activity-card">
            <div class="section-header">
                <div class="section-label">Request Activity</div>
                <div class="range-filter">
                    <button class="range-btn" data-days="7">7d</button>
                    <button class="range-btn active" data-days="14">14d</button>
                    <button class="range-btn" data-days="30">30d</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <div class="charts-grid">
            <div class="card chart-box">
                <div class="chart-title">Browsers</div>
                <div class="chart-wrapper">
                    <canvas id="browserChart"></canvas>
                    <div id="browserChart-center" class="chart-center-label"></div>
                </div>
                <div id="browserChart-legend" class="chart-legend"></div>
            </div>
            <div class="card chart-box">
                <div class="chart-title">Operating Systems</div>
                <div class="chart-wrapper">
                    <canvas id="osChart"></canvas>
                    <div id="osChart-center" class="chart-center-label"></div>
                </div>
                <div id="osChart-legend" class="chart-legend"></div>
            </div>
            <div class="card chart-box">
                <div class="chart-title">Top Countries</div>
                <div class="chart-wrapper">
                    <canvas id="countryChart"></canvas>
                    <div id="countryChart-center" class="chart-center-label"></div>
                </div>
                <div id="countryChart-legend" class="chart-legend"></div>
            </div>
        </div>

        <div class="text-center">
            <a href="/" class="btn-outline">← Back to Home</a>
        </div>

        <footer>
            <p class="credit">
                by <a href="https://lastmiles.site" target="_blank">lastmiles</a>
            </p>
            <a href="https://github.com/lastmiles0711/404-service" target="_blank" class="star-link">⭐ Star on
                GitHub</a>
        </footer>
    </main>

    <script>
        let chartInstances = {};
        let activityChartInstance = null;
        let firstLoad = true;
        let activityDays = 14;
        let cachedActivity = {};

        const CHART_COLORS = [
            '#6366f1', '#8b5cf6', '#ec4899',
            '#f59e0b', '#10b981', '#3b82f6',
            '#f43f5e', '#64748b', '#475569'
        ];

        // Override map for names that don't match Simple Icons slugs directly
        const ICON_OVERRIDES = {
            'macos': 'apple',
            'mac os': 'apple',
            'ios': 'ios',
            'ie': 'internetexplorer',
            'internet explorer': 'internetexplorer',
            'samsung internet': 'samsung',
            'mobile safari': 'safari',
            'chrome mobile': 'googlechrome',
            'firefox mobile': 'firefox',
            'edge mobile': 'microsoftedge',
            'chrome headless': 'googlechrome',
            'chrome webview': 'googlechrome',
            'android browser': 'android',
            'chrome': 'googlechrome',
            'microsoft edge': 'microsoftedge',
            'edge': 'microsoftedge',
            'opera mini': 'opera',
            'opera mobi': 'opera',
            'opera gx': 'opera',
            'opera coast': 'opera',
            'huawei browser': 'huawei',
            'miui browser': 'xiaomi',
            'uc browser': 'ucbrowser',
            'qq browser': 'tencentqq',
            'duckduckgo': 'duckduckgo',
            'tor browser': 'torbrowser',
            'arch': 'archlinux',
            'arch linux': 'archlinux',
            'chrome os': 'googlechrome',
            'chromium os': 'googlechrome',
            'harmonyos': 'harmonyos',
            'elementary os': 'elementary',
            'manjaro': 'manjaro',
            'mint': 'linuxmint',
            'linux mint': 'linuxmint',
            'pop!_os': 'popos',
            'red hat': 'redhat',
            'centos': 'centos',
            'suse': 'opensuse',
            'opensuse': 'opensuse',
        };

        function getIconSlug(name) {
            const key = name.toLowerCase().trim();
            if (ICON_OVERRIDES[key]) return ICON_OVERRIDES[key];
            // Default: lowercase, remove spaces/dots/special chars
            return key.replace(/[^a-z0-9]/g, '');
        }

        function createBrowserOrOSIcon(name) {
            if (!name || name === 'Other' || name === 'Others') return null;
            const slug = getIconSlug(name);
            const img = document.createElement('img');
            img.className = 'legend-icon';
            img.src = `https://cdn.simpleicons.org/${slug}/white`;
            img.alt = name;
            img.loading = 'lazy';
            img.onerror = function() { this.style.display = 'none'; };
            return img;
        }

        function createCountryFlag(code) {
            if (!code || code.toLowerCase() === 'unknown' || code === 'Others' || code === 'Other') return null;
            const span = document.createElement('span');
            span.className = `legend-flag fi fi-${code.toLowerCase()}`;
            return span;
        }

        async function loadStats() {
            try {
                const [statsRes, activityRes, analyticsRes] = await Promise.all([
                    fetch("/stats"),
                    fetch("/activity"),
                    fetch("/analytics")
                ]);

                const statsData = await statsRes.json();
                const activityData = await activityRes.json();
                const analyticsData = await analyticsRes.json();

                if (firstLoad) {
                    animateCounter("fetchCount", statsData.totalFetches);
                    firstLoad = false;
                } else {
                    document.getElementById("fetchCount").innerText = statsData.totalFetches.toLocaleString();
                }

                updateKPIs(analyticsData, activityData);
                cachedActivity = activityData;
                renderActivityChart(activityData);
                renderAnalyticsCharts(analyticsData);
            } catch (err) {
                console.error("Failed to load data:", err);
            }
        }

        function animateCounter(elementId, target) {
            const el = document.getElementById(elementId);
            const duration = 1200;
            const start = performance.now();

            function step(timestamp) {
                const progress = Math.min((timestamp - start) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.innerText = Math.floor(eased * target).toLocaleString();
                if (progress < 1) requestAnimationFrame(step);
                else el.innerText = target.toLocaleString();
            }
            requestAnimationFrame(step);
        }

        function getTopEntry(obj) {
            const entries = Object.entries(obj);
            if (entries.length === 0) return { name: '—', pct: 0 };
            const total = entries.reduce((s, [, v]) => s + v, 0);
            entries.sort((a, b) => b[1] - a[1]);
            return { name: entries[0][0], pct: Math.round((entries[0][1] / total) * 100) };
        }

        function dayKey(daysAgo) {
            const d = new Date();
            d.setDate(d.getDate() - daysAgo);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
        }

        function dayTotal(activity, daysAgo) {
            const key = dayKey(daysAgo);
            let count = 0;
            Object.keys(activity).forEach(k => { if (k.startsWith(key)) count += activity[k]; });
            return count;
        }

        function rangeTotal(activity, startAgo, endAgo) {
            let total = 0;
            for (let i = startAgo; i >= endAgo; i--) total += dayTotal(activity, i);
            return total;
        }

        function updateKPIs(analytics, activity) {
            const topBrowser = getTopEntry(analytics.browser);
            document.getElementById("topBrowser").innerText = topBrowser.name;
            document.getElementById("topBrowserPct").innerText = topBrowser.pct > 0 ? `${topBrowser.pct}% of traffic` : '';
            const browserIconEl = document.getElementById("topBrowserIcon");
            browserIconEl.innerHTML = '';
            if (topBrowser.name !== '—') {
                const bIcon = createBrowserOrOSIcon(topBrowser.name);
                if (bIcon) { bIcon.className = 'kpi-inline-icon'; browserIconEl.appendChild(bIcon); }
            }

            const topCountry = getTopEntry(analytics.country);
            document.getElementById("topCountry").innerText = topCountry.name;
            document.getElementById("topCountryPct").innerText = topCountry.pct > 0 ? `${topCountry.pct}% of traffic` : '';
            const countryFlagEl = document.getElementById("topCountryFlag");
            countryFlagEl.innerHTML = '';
            if (topCountry.name !== '—') {
                const cFlag = createCountryFlag(topCountry.name);
                if (cFlag) { cFlag.className += ' kpi-inline-flag'; countryFlagEl.appendChild(cFlag); }
            }

            const todayCount = dayTotal(activity, 0);
            const yesterdayCount = dayTotal(activity, 1);
            const thisWeek = rangeTotal(activity, 6, 0);
            const lastWeek = rangeTotal(activity, 13, 7);

            const trendEl = document.getElementById("fetchTrend");
            let parts = [];

            if (yesterdayCount > 0) {
                const dayChange = Math.round(((todayCount - yesterdayCount) / yesterdayCount) * 100);
                parts.push(dayChange >= 0
                    ? `<span class="trend-up">↑ ${dayChange}%</span> today`
                    : `<span class="trend-down">↓ ${Math.abs(dayChange)}%</span> today`);
            } else {
                parts.push(`<span class="trend-neutral">${todayCount}</span> today`);
            }

            if (lastWeek > 0) {
                const wowChange = Math.round(((thisWeek - lastWeek) / lastWeek) * 100);
                parts.push(wowChange >= 0
                    ? `<span class="trend-up">↑ ${wowChange}%</span> WoW`
                    : `<span class="trend-down">↓ ${Math.abs(wowChange)}%</span> WoW`);
            }

            trendEl.innerHTML = parts.join('<span class="trend-sep">·</span>');
        }

        function renderActivityChart(activity) {
            const ctx = document.getElementById('activityChart').getContext('2d');

            const labels = [];
            const dataPoints = [];
            const now = new Date();

            for (let i = activityDays - 1; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dayStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                labels.push(dayStr);

                let dailyCount = 0;
                const searchKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
                Object.keys(activity).forEach(key => {
                    if (key.startsWith(searchKey)) dailyCount += activity[key];
                });
                dataPoints.push(dailyCount);
            }

            if (activityChartInstance) {
                activityChartInstance.data.labels = labels;
                activityChartInstance.data.datasets[0].data = dataPoints;
                activityChartInstance.update();
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, 280);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.35)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                activityChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'API Calls',
                            data: dataPoints,
                            fill: true,
                            backgroundColor: gradient,
                            borderColor: '#6366f1',
                            borderWidth: 2.5,
                            tension: 0.4,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#1a1a2e',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#818cf8',
                            pointHoverBorderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 11 },
                                    padding: 8
                                },
                                border: { display: false }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: '#64748b',
                                    font: { size: 11 },
                                    padding: 8
                                },
                                border: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 15, 30, 0.9)',
                                titleColor: '#e2e8f0',
                                bodyColor: '#94a3b8',
                                borderColor: 'rgba(99, 102, 241, 0.3)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} requests`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAnalyticsCharts(data) {
            renderDoughnutChart('browserChart', 'Browsers', data.browser);
            renderDoughnutChart('osChart', 'OS', data.os);
            renderDoughnutChart('countryChart', 'Countries', data.country);
        }

        function renderDoughnutChart(canvasId, label, dataObj) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(dataObj);
            const data = Object.values(dataObj);

            const sortedIndices = data.map((val, i) => [val, i]).sort((a, b) => b[0] - a[0]);
            const sortedLabels = sortedIndices.map(item => labels[item[1]]);
            const sortedData = sortedIndices.map(item => item[0]);

            let finalLabels = sortedLabels;
            let finalData = sortedData;

            if (sortedLabels.length > 5) {
                finalLabels = sortedLabels.slice(0, 5);
                finalData = sortedData.slice(0, 5);
                const otherCount = sortedData.slice(5).reduce((a, b) => a + b, 0);
                finalLabels.push("Others");
                finalData.push(otherCount);
            }

            const total = finalData.reduce((a, b) => a + b, 0);

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].data.labels = finalLabels;
                chartInstances[canvasId].data.datasets[0].data = finalData;
                chartInstances[canvasId].update();
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: finalLabels,
                        datasets: [{
                            data: finalData,
                            backgroundColor: CHART_COLORS.slice(0, finalLabels.length),
                            borderWidth: 0,
                            hoverBorderWidth: 2,
                            hoverBorderColor: 'rgba(255,255,255,0.3)',
                            spacing: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 15, 30, 0.9)',
                                titleColor: '#e2e8f0',
                                bodyColor: '#94a3b8',
                                borderColor: 'rgba(99, 102, 241, 0.3)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        const pct = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                        return ` ${context.label}: ${context.parsed} (${pct}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '72%'
                    }
                });
            }

            const centerEl = document.getElementById(canvasId + '-center');
            if (centerEl && finalLabels.length > 0) {
                const topPct = total > 0 ? Math.round((finalData[0] / total) * 100) : 0;
                let centerIcon = '';
                if (canvasId === 'countryChart') {
                    const cc = finalLabels[0].toLowerCase();
                    if (cc !== 'unknown' && cc !== 'others') {
                        centerIcon = `<span class="fi fi-${cc} center-flag"></span>`;
                    }
                } else {
                    const slug = getIconSlug(finalLabels[0]);
                    if (finalLabels[0] !== 'Other' && finalLabels[0] !== 'Others') {
                        centerIcon = `<img class="center-icon" src="https://cdn.simpleicons.org/${slug}/white" alt="${finalLabels[0]}" onerror="this.style.display='none'">`;
                    }
                }
                centerEl.innerHTML = `<span class="center-value">${topPct}%</span>${centerIcon}<span class="center-name">${finalLabels[0]}</span>`;
            }

            const legendContainer = document.getElementById(canvasId + '-legend');
            legendContainer.innerHTML = '';
            finalLabels.forEach((label, index) => {
                const color = CHART_COLORS[index % CHART_COLORS.length];
                const value = finalData[index];
                const pct = total > 0 ? Math.round((value / total) * 100) : 0;

                const item = document.createElement('div');
                item.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;

                // Dynamically add icon based on chart type
                let iconEl = null;
                if (canvasId === 'browserChart' || canvasId === 'osChart') {
                    iconEl = createBrowserOrOSIcon(label);
                } else if (canvasId === 'countryChart') {
                    iconEl = createCountryFlag(label);
                }

                const text = document.createElement('span');
                text.className = 'legend-label';
                text.innerText = label;

                const pctSpan = document.createElement('span');
                pctSpan.className = 'legend-percent';
                pctSpan.innerText = `${pct}%`;

                item.appendChild(colorBox);
                if (iconEl) item.appendChild(iconEl);
                item.appendChild(text);
                item.appendChild(pctSpan);
                legendContainer.appendChild(item);
            });
        }

        loadStats();
        setInterval(loadStats, 5000);

        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.range-btn.active').classList.remove('active');
                btn.classList.add('active');
                activityDays = parseInt(btn.dataset.days);
                if (activityChartInstance) {
                    activityChartInstance.destroy();
                    activityChartInstance = null;
                }
                renderActivityChart(cachedActivity);
            });
        });
    </script>
</body>

</html>